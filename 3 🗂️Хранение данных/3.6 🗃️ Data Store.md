## üì± –í–≤–µ–¥–µ–Ω–∏–µ

DataStore - —ç—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–∏—à–µ–¥—à–µ–µ –Ω–∞ —Å–º–µ–Ω—É SharedPreferences. –û–Ω–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Kotlin Coroutines –∏ Flow.

![Proto DataStore.png](..\Proto%20DataStore.png)

# DataStore –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö

DataStore –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö. –ï—Å–ª–∏ –≤ –≤–∞—à–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—Ö–æ–¥–∏—Ç —á–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —Å—Å—ã–ª–æ—á–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ–ª—å—à–∏—Ö –∏ —Å–ª–æ–∂–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö, —Å—Ç–æ–∏—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ¬†[Room](https://developer.android.com/topic/libraries/architecture/room).

## üîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å SharedPreferences

|DataStore|SharedPreferences|
|---------|-----------------|
|–ò–º–µ–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π API|–ú–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã API|
|–≠—Ç–æ –Ω–µ –ø–æ–æ—â—Ä—è–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö.|SharedPreferences –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Å—Ç–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π API, –æ–¥–Ω–∞–∫–æ –µ–≥–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –ø–æ—Ç–æ–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.|
|–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å.|–≠—Ç–æ, –Ω–∞–ø—Ä–æ—Ç–∏–≤, –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ç–∞–∫–æ–π —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏|
|–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∑–≤–æ–ª—è—é—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏|–ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ SharedPrefs|
|–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç API –ø–æ—Ç–æ–∫–∞ —Å–æ–ø—Ä–æ–≥—Ä–∞–º–º Kotlin.|–û–±—â–∏–µ –ø—Ä–µ—Ñ—ã –Ω—É–∂–¥–∞—é—Ç—Å—è –≤ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞ —Å–æ–ø—Ä–æ–≥—Ä–∞–º–º.|

## üõ† –¢–∏–ø—ã DataStore

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–æ—Ä—É—Ç–∏–Ω Kotlin –∏ Flow API, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –µ—ë –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∏ –Ω–∞–¥–µ–∂–Ω–æ–π, —á–µ–º –æ–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. –ü—Ä–µ–¥–ª–∞–≥–∞—é—Ç—Å—è –¥–≤–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–∞ –∫ —Ö—Ä–∞–Ω–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö:

### 1. Preferences DataStore

* –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ
* –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
* –ù–µ—Ç —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 2. Proto DataStore

* –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Protocol Buffers
* –°—Ç—Ä–æ–≥–∞—è —Å—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö

## üíª –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–ß—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É Jetpack DataStore, –¥–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É –ø–æ–¥ —É–∑–ª–æ–º¬†`dependencies`¬†–≤ —Ñ–∞–π–ª–µ¬†`build.gradle`¬†—É—Ä–æ–≤–Ω—è app.

````kotlin
dependencies {
    // Preferences DataStore
    implementation("androidx.datastore:datastore-preferences:1.0.0")
    
    // Proto DataStore
    implementation("androidx.datastore:datastore:1.0.0")
}
````

## üì± –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã

### Preferences DataStore

````kotlin
class PreferenceManager(context: Context) {
    private val Context.dataStore: DataStore<Preferences> by preferencesDataStore(name = "settings")
    private val dataStore = context.dataStore

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π
    companion object {
        val USER_NAME = stringPreferencesKey("user_name")
        val IS_DARK_MODE = booleanPreferencesKey("dark_mode")
        val NOTIFICATION_COUNT = intPreferencesKey("notification_count")
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    suspend fun saveUserName(name: String) {
        dataStore.edit { preferences ->
            preferences[USER_NAME] = name
        }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    val userNameFlow: Flow<String> = dataStore.data
        .catch { exception ->
            if (exception is IOException) {
                emit(emptyPreferences())
            } else {
                throw exception
            }
        }
        .map { preferences ->
            preferences[USER_NAME] ?: ""
        }
}
````

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Compose

````kotlin
@Composable
fun SettingsScreen(
    preferenceManager: PreferenceManager = remember { PreferenceManager(LocalContext.current) }
) {
    var userName by remember { mutableStateOf("") }
    val scope = rememberCoroutineScope()

    // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ Flow
    LaunchedEffect(Unit) {
        preferenceManager.userNameFlow.collect { name ->
            userName = name
        }
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp)
    ) {
        OutlinedTextField(
            value = userName,
            onValueChange = { newName ->
                userName = newName
                scope.launch {
                    preferenceManager.saveUserName(newName)
                }
            },
            label = { Text("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è") },
            modifier = Modifier.fillMaxWidth()
        )
    }
}
````

### Proto DataStore –ø—Ä–∏–º–µ—Ä

````kotlin
// settings.proto
syntax = "proto3";

option java_package = "com.example.app";
option java_multiple_files = true;

message Settings {
    string user_name = 1;
    bool is_dark_mode = 2;
    int32 notification_count = 3;
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ
class SettingsSerializer : Serializer<Settings> {
    override val defaultValue: Settings = Settings.getDefaultInstance()

    override suspend fun readFrom(input: InputStream): Settings {
        return Settings.parseFrom(input)
    }

    override suspend fun writeTo(t: Settings, output: OutputStream) {
        t.writeTo(output)
    }
}
````

## üöÄ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DataStore

1. –î–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö
1. –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞
1. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Proto DataStore)
1. –î–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

1. Room - –¥–ª—è –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö
1. File Storage - –¥–ª—è —Ñ–∞–π–ª–æ–≤ –∏ –º–µ–¥–∏–∞
1. SharedPreferences - —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

* [DataStore Documentation](https://developer.android.com/topic/libraries/architecture/datastore)
* [Proto DataStore Guide](https://developer.android.com/topic/libraries/architecture/datastore#proto-datastore)
* [Migrating from SharedPreferences](https://developer.android.com/topic/libraries/architecture/datastore#migrate)
* [–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç—å—è –Ω–∞ Habr](https://habr.com/ru/companies/tbank/articles/525010/)

## üé• –í–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

[![Watch the video](https://img.youtube.com/vi/yMGAbm84iIY/0.jpg)](https://www.youtube.com/watch?v=yMGAbm84iIY&t=5s&pp=ygUSYW5kcm9pZCBEYXRhIFN0b3Jl)

[![Watch the video](https://img.youtube.com/vi/9ws-cJzlJkU/0.jpg)](https://www.youtube.com/watch?v=9ws-cJzlJkU&list=PLWz5rJ2EKKc8to3Ere-ePuco69yBUmQ9C)
[![Watch the video](https://img.youtube.com/vi/kp53qL_O5gk/0.jpg)](https://www.youtube.com/watch?v=kp53qL_O5gk&pp=ygUSYW5kcm9pZCBEYXRhIFN0b3Jl)
