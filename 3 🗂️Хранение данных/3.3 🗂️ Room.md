# üóÇÔ∏è Room Database

## üì± –í–≤–µ–¥–µ–Ω–∏–µ

![dbs.gif](../images/dbs.gif)

Room - —ç—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SQLite –≤ Android, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è —É–¥–æ–±–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –Ω–∞–¥ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
–û–Ω–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å, —É–¥–∞–ª—è—Ç—å –∏ –ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ä–≥–∞–Ω–∞–π–∑–µ—Ä.

* **–ü–æ—á–µ–º—É Room?**
  
  * –£–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å SQLite (–Ω–µ –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –≤—Ä—É—á–Ω—É—é).
  
  * –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
  
  * –ë–æ–ª–µ–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ö—Ä–∞–Ω–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞.
  
  * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—à–∏–±–∫–∏ –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ (–µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Å–æ–±–µ—Ä–µ—Ç—Å—è). –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.
  
  * –°–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å Kotlin Coroutines –∏ Flow –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã.

* –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö SQLite, –æ—Å–æ–±–µ–Ω–Ω–æ –∫–æ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è ORM (Object-Relational Mapping).

* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

* –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã, —á—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—à–∏–±–æ–∫ SQL.
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ LiveData –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI.

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**

* –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å SharedPreferences. –¢—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –∫–æ–¥–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ Entity, DAO, Database).
* –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–º –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫.

![roomlogo.png](../images/roomlogo.png)
**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Room:**

1. **Entity (–°—É—â–Ω–æ—Å—Ç—å)** ‚Äî –∫–∞–∫ —Ç–∞–±–ª–∏—Ü–∞ –≤ Excel. ¬†–ö–∞–∂–¥–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –∫–ª–∞—Å—Å–∞ - –∫–æ–ª–æ–Ω–∫–∞ —Ç–∞–±–ª–∏—Ü—ã.

2. **DAO (Data Access Object)** ‚Äî –Ω–∞–±–æ—Ä –∫–æ–º–∞–Ω–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–µ–π (–¥–æ–±–∞–≤–∏—Ç—å, —É–¥–∞–ª–∏—Ç—å, –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ). ¬†–û–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, —á—Ç–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏).

3. **Database** ‚Äî —Å–∞–º–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è —Å–≤—è–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏ DAO. ¬†–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å, —Ä–∞—Å—à–∏—Ä—è—é—â–∏–π¬†RoomDatabase, —Å–æ–∑–¥–∞—é—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –¥–æ—Å—Ç—É–ø –∫ DAO.

## üõ† –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

4. –î–æ–±–∞–≤—å—Ç–µ KSP –≤ Project build.gradle:

````kotlin
plugins {
    id("com.google.devtools.ksp") version "1.9.21-1.0.15" apply false
}
````

5. –í Module build.gradle:

````kotlin
plugins {
    id("com.google.devtools.ksp")
}

dependencies {
    val roomVersion = "2.6.1"
    
    implementation("androidx.room:room-runtime:$roomVersion")
    implementation("androidx.room:room-ktx:$roomVersion")
    ksp("androidx.room:room-compiler:$roomVersion")
}
````

## üèóÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Room

### 1. Entity (–°—É—â–Ω–æ—Å—Ç—å)

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã:

````kotlin
@Entity(tableName = "notes") // –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
data class Note(
    @PrimaryKey(autoGenerate = true) // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
    val id: Int = 0,
    
    @ColumnInfo(name = "title") // –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ 
    val title: String,
    
    @ColumnInfo(name = "content") // –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ 
    val content: String,
    
    @ColumnInfo(name = "created_at") // –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ 
    val createdAt: Long = System.currentTimeMillis()
)
````

**–†–∞–∑–±–æ—Ä:**

* `@Entity` ‚Äî –æ—Ç–º–µ—á–∞–µ—Ç –∫–ª–∞—Å—Å –∫–∞–∫ —Ç–∞–±–ª–∏—Ü—É.

* `@PrimaryKey` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.

* `@ColumnInfo` ‚Äî –∑–∞–¥–∞–µ—Ç –∏–º—è —Å—Ç–æ–ª–±—Ü–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å, –±—É–¥–µ—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π).

### 2. DAO (Data Access Object)

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:

````kotlin
@Dao  // Data Access Object
interface NoteDao {
    @Query("SELECT * FROM notes ORDER BY created_at DESC")
    fun getAllNotes(): Flow<List<Note>> // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–º–µ—Ç–∫–∏
    
    @Query("SELECT * FROM notes WHERE id = :noteId")
    suspend fun getNoteById(noteId: Int): Note? // –ü–æ–ª—É—á–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
    
    @Insert
    suspend fun insertNote(note: Note): Long // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
    
    @Update
    suspend fun updateNote(note: Note)   // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
    
    @Delete
    suspend fun deleteNote(note: Note)   // –£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
    
    @Query("DELETE FROM notes")
    suspend fun deleteAllNotes()   // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–º–µ—Ç–∫–∏
}
````

**–†–∞–∑–±–æ—Ä:**

* `@Insert`, `@Delete` ‚Äî –≥–æ—Ç–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.

* `@Query` ‚Äî —Ä—É—á–Ω–æ–π SQL-–∑–∞–ø—Ä–æ—Å.

* `suspend` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ (–∫–æ—Ä—É—Ç–∏–Ω—ã).

* `Flow` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã.

### 3. Database

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

````kotlin
@Database(
    entities = [Note::class],  // –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
    version = 1, // –í–µ—Ä—Å–∏—è –±–∞–∑—ã (—É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã)
    exportSchema = false
)
abstract class AppDatabase : RoomDatabase() {
    abstract fun noteDao(): NoteDao // –î–æ—Å—Ç—É–ø –∫ DAO

    companion object {
        @Volatile
        private var INSTANCE: AppDatabase? = null  // –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ==

        fun getDatabase(context: Context): AppDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    AppDatabase::class.java,
                    "app_database"  // –ò–º—è —Ñ–∞–π–ª–∞ –±–∞–∑—ã
                ).build()
                INSTANCE = instance
                instance
            }
        }
    }
}
````

## üì± –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫

### Repository

````kotlin
class NoteRepository(private val noteDao: NoteDao) {
    val allNotes: Flow<List<Note>> = noteDao.getAllNotes()
    
    suspend fun insertNote(note: Note) {
        noteDao.insertNote(note)
    }
    
    suspend fun updateNote(note: Note) {
        noteDao.updateNote(note)
    }
    
    suspend fun deleteNote(note: Note) {
        noteDao.deleteNote(note)
    }
}
````

### ViewModel

````kotlin
class NoteViewModel(application: Application) : AndroidViewModel(application) {
    private val repository: NoteRepository
    val allNotes: StateFlow<List<Note>>

    init {
        val noteDao = AppDatabase.getDatabase(application).noteDao()
        repository = NoteRepository(noteDao)
        allNotes = repository.allNotes.stateIn(
            viewModelScope,
            SharingStarted.WhileSubscribed(5000),
            emptyList()
        )
    }

    fun addNote(title: String, content: String) {
        viewModelScope.launch {
            repository.insertNote(Note(title = title, content = content))
        }
    }

    fun deleteNote(note: Note) {
        viewModelScope.launch {
            repository.deleteNote(note)
        }
    }
}
````

### UI

````kotlin
@Composable
fun NotesScreen(
    viewModel: NoteViewModel = viewModel()
) {
    val notes by viewModel.allNotes.collectAsState()
    var showDialog by remember { mutableStateOf(false) }
    var title by remember { mutableStateOf("") }
    var content by remember { mutableStateOf("") }

    Column(modifier = Modifier.fillMaxSize()) {
        // –°–ø–∏—Å–æ–∫ –∑–∞–º–µ—Ç–æ–∫
        LazyColumn(
            modifier = Modifier.weight(1f),
            contentPadding = PaddingValues(16.dp)
        ) {
            items(notes) { note ->
                NoteItem(
                    note = note,
                    onDelete = { viewModel.deleteNote(note) }
                )
                Spacer(modifier = Modifier.height(8.dp))
            }
        }

        // FAB –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏
        FloatingActionButton(
            onClick = { showDialog = true },
            modifier = Modifier
                .padding(16.dp)
                .align(Alignment.End)
        ) {
            Icon(Icons.Default.Add, "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É")
        }
    }

    // –î–∏–∞–ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏
    if (showDialog) {
        AlertDialog(
            onDismissRequest = { showDialog = false },
            title = { Text("–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞") },
            text = {
                Column {
                    TextField(
                        value = title,
                        onValueChange = { title = it },
                        label = { Text("–ó–∞–≥–æ–ª–æ–≤–æ–∫") }
                    )
                    Spacer(modifier = Modifier.height(8.dp))
                    TextField(
                        value = content,
                        onValueChange = { content = it },
                        label = { Text("–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ") }
                    )
                }
            },
            confirmButton = {
                Button(onClick = {
                    viewModel.addNote(title, content)
                    title = ""
                    content = ""
                    showDialog = false
                }) {
                    Text("–î–æ–±–∞–≤–∏—Ç—å")
                }
            },
            dismissButton = {
                Button(onClick = { showDialog = false }) {
                    Text("–û—Ç–º–µ–Ω–∞")
                }
            }
        )
    }
}
````

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ú–∏–≥—Ä–∞—Ü–∏–∏

````kotlin
val MIGRATION_1_2 = object : Migration(1, 2) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL(
            "ALTER TABLE notes ADD COLUMN priority INTEGER NOT NULL DEFAULT 0"
        )
    }
}
````

### –û—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

````kotlin
@Entity(tableName = "categories")
data class Category(
    @PrimaryKey val id: Int,
    val name: String
)

@Entity(
    tableName = "notes",
    foreignKeys = [
        ForeignKey(
            entity = Category::class,
            parentColumns = ["id"],
            childColumns = ["category_id"]
        )
    ]
)
data class Note(
    @PrimaryKey(autoGenerate = true) val id: Int = 0,
    val title: String,
    @ColumnInfo(name = "category_id") val categoryId: Int
)
````

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

* [–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ ¬´Room¬ª –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–µ–≥–æ Android-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞](https://habr.com/ru/articles/713518/)
* [–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ ¬´Room¬ª Android dev](https://developer.android.com/jetpack/androidx/releases/room?hl=ru)
* [–ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](https://devgem.vercel.app/posts/resolving-issues-with-hilt-room-and-ksp-in-android-development)
* [Room Documentation](https://developer.android.com/training/data-storage/room)
* [Room KSP Migration](https://developer.android.com/build/migrate-to-ksp)
* [Room with Coroutines](https://developer.android.com/training/data-storage/room/async-queries)
* [Testing Room](https://developer.android.com/training/data-storage/room/testing-db)

## üé• –í–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

[![Watch the video](https://img.youtube.com/vi/lwAvI3WDXBY/0.jpg)](https://www.youtube.com/watch?v=lwAvI3WDXBY&list=PLSrm9z4zp4mEPOfZNV9O-crOhoMa0G2-o)
[![Watch the video](https://img.youtube.com/vi/BVAslimaGSk/0.jpg)](https://www.youtube.com/watch?v=BVAslimaGSk&pp=ygUVYW5kcm9pZCBzcWxpdGUga290bGlu)
