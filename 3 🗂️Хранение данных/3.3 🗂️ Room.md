# üóÇÔ∏è Room Database

## üì± –í–≤–µ–¥–µ–Ω–∏–µ

![dbs.gif](../images/dbs.gif)

Room - —ç—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SQLite –≤ Android, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è —É–¥–æ–±–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –Ω–∞–¥ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
–û–Ω–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å, —É–¥–∞–ª—è—Ç—å –∏ –ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ä–≥–∞–Ω–∞–π–∑–µ—Ä.

* **–ü–æ—á–µ–º—É Room?**
  
  * –£–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å SQLite (–Ω–µ –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –≤—Ä—É—á–Ω—É—é).
  
  * –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
  
  * –ë–æ–ª–µ–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ö—Ä–∞–Ω–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞.
  
  * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—à–∏–±–∫–∏ –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ (–µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Å–æ–±–µ—Ä–µ—Ç—Å—è). –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.
  
  * –°–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å Kotlin Coroutines –∏ Flow –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã.

* –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö SQLite, –æ—Å–æ–±–µ–Ω–Ω–æ –∫–æ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è ORM (Object-Relational Mapping).

* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

* –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã, —á—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—à–∏–±–æ–∫ SQL.
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ LiveData –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI.

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**

* –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å SharedPreferences. –¢—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –∫–æ–¥–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ Entity, DAO, Database).
* –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–º –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫.

![roomlogo.png](../images/roomlogo.png)
**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Room:**

1. **Entity (–°—É—â–Ω–æ—Å—Ç—å)** ‚Äî –∫–∞–∫ —Ç–∞–±–ª–∏—Ü–∞ –≤ Excel. ¬†–ö–∞–∂–¥–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –∫–ª–∞—Å—Å–∞ - –∫–æ–ª–æ–Ω–∫–∞ —Ç–∞–±–ª–∏—Ü—ã. –ö–ª–∞—Å—Å –¥–∞–Ω–Ω—ã—Ö (data class), –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.  –ö–∞–∂–¥–æ–µ –ø–æ–ª–µ –∫–ª–∞—Å—Å–∞ ‚Äì —ç—Ç–æ —Å—Ç–æ–ª–±–µ—Ü —Ç–∞–±–ª–∏—Ü—ã.

2. **DAO (Data Access Object)** ‚Äî –Ω–∞–±–æ—Ä –∫–æ–º–∞–Ω–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–µ–π (–¥–æ–±–∞–≤–∏—Ç—å, —É–¥–∞–ª–∏—Ç—å, –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ). ¬†–û–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, —á—Ç–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏). –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç–æ–¥—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º (CRUD: Create, Read, Update, Delete).  Room –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é DAO –≤–æ –≤—Ä–µ–º—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏.

3. **Database** ‚Äî —Å–∞–º–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è —Å–≤—è–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏ DAO. ¬†–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å, —Ä–∞—Å—à–∏—Ä—è—é—â–∏–π¬†RoomDatabase, —Å–æ–∑–¥–∞—é—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –¥–æ—Å—Ç—É–ø –∫ DAO.

## üõ† –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

4. –î–æ–±–∞–≤—å—Ç–µ KSP –≤ Project build.gradle:

````kotlin
plugins {
    id("com.google.devtools.ksp") version "1.9.21-1.0.15" apply false
}
````

5. –í Module build.gradle:

````kotlin
plugins {
    id("com.google.devtools.ksp")
}

dependencies {
   implementation(libs.androidx.room.runtime)  
	implementation(libs.androidx.room.ktx)  
	ksp(libs.androidx.room.compiler)
}
````

## üèóÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Room

### 1. Entity (–°—É—â–Ω–æ—Å—Ç—å)

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã:

````kotlin
import androidx.room.Entity
import androidx.room.PrimaryKey

@Entity(tableName = "tasks") // –ò–º—è —Ç–∞–±–ª–∏—Ü—ã
data class Task(
    @PrimaryKey(autoGenerate = true) // –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á (–∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç)
    val id: Int = 0,
    val title: String,
    val description: String?,
    val isCompleted: Boolean
)
````

**–†–∞–∑–±–æ—Ä:**

* `@Entity` ‚Äî –æ—Ç–º–µ—á–∞–µ—Ç –∫–ª–∞—Å—Å –∫–∞–∫ —Ç–∞–±–ª–∏—Ü—É.  –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ Entity (—Ç–∞–±–ª–∏—Ü–∞).

* `@PrimaryKey` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.  –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏).  `autoGenerate = true` –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª—é—á–∞ –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç).

* `@ColumnInfo` ‚Äî –∑–∞–¥–∞–µ—Ç –∏–º—è —Å—Ç–æ–ª–±—Ü–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å, –±—É–¥–µ—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π).

### 2. –°–æ–∑–¥–∞–Ω–∏–µ DAO (Data Access Object)

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:

````kotlin
import androidx.room.Dao
import androidx.room.Delete
import androidx.room.Insert
import androidx.room.OnConflictStrategy
import androidx.room.Query
import androidx.room.Update
import kotlinx.coroutines.flow.Flow

@Dao
interface TaskDao {
    @Query("SELECT * FROM tasks")
    fun getAllTasks(): Flow<List<Task>> // Flow - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

    @Query("SELECT * FROM tasks WHERE id = :taskId")
    fun getTaskById(taskId: Int): Flow<Task?>

    @Insert(onConflict = OnConflictStrategy.REPLACE) // –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É —Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º ID)
    suspend fun insertTask(task: Task)

    @Update
    suspend fun updateTask(task: Task)

    @Delete
    suspend fun deleteTask(task: Task)

    @Query("DELETE FROM tasks WHERE id = :taskId")
    suspend fun deleteTaskById(taskId: Int) //–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ ID
}
````

**–†–∞–∑–±–æ—Ä:**
**`@Dao`:**  –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ DAO.
*   **`@Query(...)`:**  –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤.
    *   **`SELECT * FROM tasks`:**  –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `tasks`.
    *   **`SELECT * FROM tasks WHERE id = :taskId`:**  –í—ã–±—Ä–∞—Ç—å –∑–∞–ø–∏—Å—å —Å –∑–∞–¥–∞–Ω–Ω—ã–º ID. `:taskId` ‚Äì —ç—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –º–µ—Ç–æ–¥ `getTaskById`.
*   **`@Insert(onConflict = OnConflictStrategy.REPLACE)`:**  –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É. `onConflict = OnConflictStrategy.REPLACE` –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º –∂–µ –ø–µ—Ä–≤–∏—á–Ω—ã–º –∫–ª—é—á–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–Ω–∞ –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–∞.
*   **`@Update`:**  –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.
*   **`@Delete`:**  –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.
*   **`Flow<...>`:**  –í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π —Ç–∏–ø –¥–ª—è –º–µ—Ç–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—É—á–∞—é—Ç –¥–∞–Ω–Ω—ã–µ. `Flow` ‚Äì —ç—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö (–∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ kotlinx.coroutines).  –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
*   **`suspend`:**  –ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –º–µ—Ç–æ–¥ –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ –∫–æ—Ä—É—Ç–∏–Ω–µ. –ú–µ—Ç–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑–º–µ–Ω—è—é—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (insert, update, delete), –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å suspend.

* `Flow` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã.

### 3. –°–æ–∑–¥–∞–Ω–∏–µ Database

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

````kotlin
// AppDatabase.kt
import android.content.Context
import androidx.room.Database
import androidx.room.Room
import androidx.room.RoomDatabase

@Database(entities = [Task::class], version = 1, exportSchema = false)
abstract class AppDatabase : RoomDatabase() {

    abstract fun taskDao(): TaskDao

    companion object {
        @Volatile // –î–µ–ª–∞–µ—Ç –ø–æ–ª–µ –≤–∏–¥–∏–º—ã–º –¥–ª—è –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤
        private var INSTANCE: AppDatabase? = null

        fun getDatabase(context: Context): AppDatabase {
            // –ï—Å–ª–∏ INSTANCE –Ω–µ null, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ,
            // –µ—Å–ª–∏ null, —Å–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            return INSTANCE ?: synchronized(this) { // synchronized - —á—Ç–æ–±—ã —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –º–æ–≥ —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    AppDatabase::class.java,
                    "task_database" // –ò–º—è —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                )
                .fallbackToDestructiveMigration() // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –ë–î (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤), –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –í production —Ç–∞–∫ –¥–µ–ª–∞—Ç—å –Ω–µ —Å—Ç–æ–∏—Ç!
                .build()
                INSTANCE = instance
                // return instance
                instance
            }
        }
    }
}
````
  **`@Database(entities = [Task::class], version = 1, exportSchema = false)`:**  –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.
    *   **`entities = [Task::class]`:**  –°–ø–∏—Å–æ–∫ Entity (—Ç–∞–±–ª–∏—Ü), –∫–æ—Ç–æ—Ä—ã–µ –≤—Ö–æ–¥—è—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
    *   **`version = 1`:**  –í–µ—Ä—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.  –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü, —Å—Ç–æ–ª–±—Ü–æ–≤) –Ω—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –≤–µ—Ä—Å–∏—é.
    *    **`exportSchema = false`:**  –ù–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–æ–±—ã—á–Ω–æ –Ω–µ –Ω—É–∂–Ω–æ).
*   **`abstract class AppDatabase : RoomDatabase()`:**  –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `RoomDatabase`.
*   **`abstract fun taskDao(): TaskDao`:**  –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç DAO.
*   **`companion object { ... }`:**  Singleton (–æ–¥–∏–Ω–æ—á–∫–∞) ‚Äì —á—Ç–æ–±—ã –±—ã–ª —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    *   **`@Volatile private var INSTANCE: AppDatabase? = null`:**  –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. `@Volatile` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤—Å–µ–º –ø–æ—Ç–æ–∫–∞–º.
    *   **`fun getDatabase(context: Context): AppDatabase`:**  –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
        *   –ï—Å–ª–∏ `INSTANCE` –Ω–µ `null`, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ.
        *   –ï—Å–ª–∏ `INSTANCE` —Ä–∞–≤–µ–Ω `null`, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é `Room.databaseBuilder`.
            *   **`context.applicationContext`:**  –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
            *   **`AppDatabase::class.java`:**  –ö–ª–∞—Å—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
            *   **`"task_database"`:**  –ò–º—è —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
            * **`.fallbackToDestructiveMigration()`:**  –£–∫–∞–∑—ã–≤–∞–µ—Ç Room, —á—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ `version`).  –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `.fallbackToDestructiveMigration()`, –∫–æ—Ç–æ—Ä—ã–π *—É–¥–∞–ª—è–µ—Ç* –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∑–∞–Ω–æ–≤–æ.  –í *production* –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö —Ç–∞–∫ –¥–µ–ª–∞—Ç—å *–Ω–µ–ª—å–∑—è*! –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å *–º–∏–≥—Ä–∞—Ü–∏–∏* (Migrations), –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö.
            *   **`.build()`:**  –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.


## üì± –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫

### Repository

````kotlin
class NoteRepository(private val noteDao: NoteDao) {
    val allNotes: Flow<List<Note>> = noteDao.getAllNotes()
    
    suspend fun insertNote(note: Note) {
        noteDao.insertNote(note)
    }
    
    suspend fun updateNote(note: Note) {
        noteDao.updateNote(note)
    }
    
    suspend fun deleteNote(note: Note) {
        noteDao.deleteNote(note)
    }
}
````

### ViewModel

````kotlin
class NoteViewModel(application: Application) : AndroidViewModel(application) {
    private val repository: NoteRepository
    val allNotes: StateFlow<List<Note>>

    init {
        val noteDao = AppDatabase.getDatabase(application).noteDao()
        repository = NoteRepository(noteDao)
        allNotes = repository.allNotes.stateIn(
            viewModelScope,
            SharingStarted.WhileSubscribed(5000),
            emptyList()
        )
    }

    fun addNote(title: String, content: String) {
        viewModelScope.launch {
            repository.insertNote(Note(title = title, content = content))
        }
    }

    fun deleteNote(note: Note) {
        viewModelScope.launch {
            repository.deleteNote(note)
        }
    }
}
````

### UI

````kotlin
@Composable
fun NotesScreen(
    viewModel: NoteViewModel = viewModel()
) {
    val notes by viewModel.allNotes.collectAsState()
    var showDialog by remember { mutableStateOf(false) }
    var title by remember { mutableStateOf("") }
    var content by remember { mutableStateOf("") }

    Column(modifier = Modifier.fillMaxSize()) {
        // –°–ø–∏—Å–æ–∫ –∑–∞–º–µ—Ç–æ–∫
        LazyColumn(
            modifier = Modifier.weight(1f),
            contentPadding = PaddingValues(16.dp)
        ) {
            items(notes) { note ->
                NoteItem(
                    note = note,
                    onDelete = { viewModel.deleteNote(note) }
                )
                Spacer(modifier = Modifier.height(8.dp))
            }
        }

        // FAB –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏
        FloatingActionButton(
            onClick = { showDialog = true },
            modifier = Modifier
                .padding(16.dp)
                .align(Alignment.End)
        ) {
            Icon(Icons.Default.Add, "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É")
        }
    }

    // –î–∏–∞–ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏
    if (showDialog) {
        AlertDialog(
            onDismissRequest = { showDialog = false },
            title = { Text("–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞") },
            text = {
                Column {
                    TextField(
                        value = title,
                        onValueChange = { title = it },
                        label = { Text("–ó–∞–≥–æ–ª–æ–≤–æ–∫") }
                    )
                    Spacer(modifier = Modifier.height(8.dp))
                    TextField(
                        value = content,
                        onValueChange = { content = it },
                        label = { Text("–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ") }
                    )
                }
            },
            confirmButton = {
                Button(onClick = {
                    viewModel.addNote(title, content)
                    title = ""
                    content = ""
                    showDialog = false
                }) {
                    Text("–î–æ–±–∞–≤–∏—Ç—å")
                }
            },
            dismissButton = {
                Button(onClick = { showDialog = false }) {
                    Text("–û—Ç–º–µ–Ω–∞")
                }
            }
        )
    }
}
````

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ú–∏–≥—Ä–∞—Ü–∏–∏

````kotlin
val MIGRATION_1_2 = object : Migration(1, 2) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL(
            "ALTER TABLE notes ADD COLUMN priority INTEGER NOT NULL DEFAULT 0"
        )
    }
}
````

### –û—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

````kotlin
@Entity(tableName = "categories")
data class Category(
    @PrimaryKey val id: Int,
    val name: String
)

@Entity(
    tableName = "notes",
    foreignKeys = [
        ForeignKey(
            entity = Category::class,
            parentColumns = ["id"],
            childColumns = ["category_id"]
        )
    ]
)
data class Note(
    @PrimaryKey(autoGenerate = true) val id: Int = 0,
    val title: String,
    @ColumnInfo(name = "category_id") val categoryId: Int
)
````

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

* [–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ ¬´Room¬ª –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–µ–≥–æ Android-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞](https://habr.com/ru/articles/713518/)
* [–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ ¬´Room¬ª Android dev](https://developer.android.com/jetpack/androidx/releases/room?hl=ru)
* [–ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](https://devgem.vercel.app/posts/resolving-issues-with-hilt-room-and-ksp-in-android-development)
* [Room Documentation](https://developer.android.com/training/data-storage/room)
* [Room KSP Migration](https://developer.android.com/build/migrate-to-ksp)
* [Room with Coroutines](https://developer.android.com/training/data-storage/room/async-queries)
* [Testing Room](https://developer.android.com/training/data-storage/room/testing-db)

## üé• –í–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

[![Watch the video](https://img.youtube.com/vi/lwAvI3WDXBY/0.jpg)](https://www.youtube.com/watch?v=lwAvI3WDXBY&list=PLSrm9z4zp4mEPOfZNV9O-crOhoMa0G2-o)
[![Watch the video](https://img.youtube.com/vi/BVAslimaGSk/0.jpg)](https://www.youtube.com/watch?v=BVAslimaGSk&pp=ygUVYW5kcm9pZCBzcWxpdGUga290bGlu)
